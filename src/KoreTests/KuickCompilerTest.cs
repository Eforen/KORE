using Kore;
using Kore.RiscISA.Instruction;
using NSubstitute;
using NUnit.Framework;
using System;
using System.Collections.Generic;
using System.Linq.Expressions;
using System.Text;

namespace KoreTests
{
    public class KuickCompilerTest
    {
        /*  0 */ [TestCase("addi  a3,a0,4   # Lorem ipsum dolor sit amet, consectetur adipiscing elit.", 0x00450693u)]
        /*  4 */ [TestCase("addi  a4,x0,1   # Sed eget nisl eget ipsum rutrum congue id in libero.", 0x00100713u)]
        /*  8 */ [TestCase("bltu  a4,a1,10  # Aenean nec lacus eget diam placerat accumsan nec et nunc.", 0x00b76463u)]
        /*  C */ [TestCase("jalr  x0,x1,0   # Ut ultrices diam et bibendum bibendum.", 0x00008067u)]
        /* 10 */ [TestCase("lw    a6, 0(a3) # Aenean congue nunc non molestie accumsan.", 0x0006a803u)]
        /* 14 */ [TestCase("addi  a2,a3,0   # Maecenas tincidunt nisi non pretium vulputate.", 0x00068613u)]
        /* 18 */ [TestCase("addi  a5,a4,0   # Aliquam pharetra justo eget erat consectetur pharetra.", 0x00070793u)]
        /* 1C */ [TestCase("lw    a7,-4(a2) # Nunc condimentum felis eget fermentum sodales.", 0xffc62883u)]
        /* 20 */ [TestCase("bge   a6,a7,34  # Praesent vel nulla varius metus consequat mattis.", 0x01185a63u)]
        /* 24 */ [TestCase("sw    a7,0(a2)  # Curabitur volutpat quam convallis dolor tempus viverra.", 0x01162023u)]
        /* 28 */ [TestCase("addi  a5,a5,-1   ", 0xfff78793u)]
        /* 2C */ [TestCase("addi  a2,a2,-4  # Duis sagittis ante a quam faucibus suscipit.", 0xffc60613u)]
        /* 30 */ [TestCase("bne   a5,x0,1c   ", 0xfe0796e3u)]
        /* 34 */ [TestCase("slli  a5,a5,2 # Pellentesque ut lacus at tellus hendrerit iaculis ac in nunc.", 0x00279793u)]
        /* 38 */ [TestCase("add a5,a0,a5 # Curabitur quis nisl eget nisi posuere tempus in a nibh.", 0x00f507b3u)]
        /* 3C */ [TestCase("sw a6,0(a5) # Morbi rutrum risus viverra, placerat leo in, facilisis urna.", 0x0107a023u)]
        /* 40 */ [TestCase("addi a4,a4,1 # Fusce in erat eu turpis convallis ultrices sed bibendum justo.", 0x00170713u)]
        /* 44 */ [TestCase("addi a3,a3,4 # foo", 0x00468693u)]
        /* 48 */ [TestCase("jal x0, 8 # Bar", 0xfc1ff06fu)]
        [TestCase("li      a5,0", 0x00000793u)]
        [TestCase("lui     a0,0x10", 0x00010537u)]
        [TestCase("ret", 0x00008067u)]
        [TestCase("auipc   gp,0x2", 0x00002197u)]
        [TestCase("sub     a2,a2,a0", 0x40a60633u)]
        [TestCase("li      a1,0", 0x00000593u)]
        [TestCase("auipc   a0,0x0", 0x00000517u)]
        [TestCase("lw      a0,0(sp)", 0x00012503u)]
        [TestCase("addi    a1,sp,8", 0x00810593u)]
        [TestCase("li      a2,0", 0x00000613u)]
        [TestCase("addi    sp,sp,-16", 0xff010113u)]
        [TestCase("sd      s0,0(sp)", 0x00813023u)]
        [TestCase("mv      s0,a5", 0x00078413u)]
        [TestCase("sd      ra,8(sp)", 0x00113423u)]
        [TestCase("lui     a0,0x11", 0x00011537u)]
        [TestCase("auipc   ra,0x0", 0x00000097u)]
        [TestCase("li      a5,1", 0x00100793u)]
        [TestCase("ld      ra,8(sp)", 0x00813083u)]
        [TestCase("ld      s0,0(sp)", 0x00013403u)]
        [TestCase("addi    sp,sp,16", 0x01010113u)]
        [TestCase("auipc   t1,0x0", 0x00000317u)]
        [TestCase("mv      s0,a0", 0x00050413u)]
        [TestCase("ld      a5,88(a0)", 0x05853783u)]
        [TestCase("jalr    a5", 0x000780e7u)]
        [TestCase("mv      a0,s0", 0x00040513u)]
        [TestCase("addi    sp,sp,-32", 0xfe010113u)]
        [TestCase("sd      s0,16(sp)", 0x00813823u)]
        [TestCase("sd      s2,0(sp)", 0x01213023u)]
        [TestCase("lui     s0,0x11", 0x00011437u)]
        [TestCase("lui     s2,0x11", 0x00011937u)]
        [TestCase("sub     s2,s2,a5", 0x40f90933u)]
        [TestCase("sd      ra,24(sp)", 0x00113c23u)]
        [TestCase("sd      s1,8(sp)", 0x00913423u)]
        [TestCase("srai    s2,s2,0x3", 0x40395913u)]
        [TestCase("addi    s0,s0,1468", 0x5bc40413u)]
        [TestCase("li      s1,0", 0x00000493u)]
        [TestCase("ld      a5,0(s0)", 0x00043783u)]
        [TestCase("addi    s1,s1,1", 0x00148493u)]
        [TestCase("addi    s0,s0,8", 0x00840413u)]
        [TestCase("addi    s0,s0,1472", 0x5c040413u)]
        [TestCase("ld      ra,24(sp)", 0x01813083u)]
        [TestCase("ld      s0,16(sp)", 0x01013403u)]
        [TestCase("ld      s1,8(sp)", 0x00813483u)]
        [TestCase("ld      s2,0(sp)", 0x00013903u)]
        [TestCase("addi    sp,sp,32", 0x02010113u)]
        [TestCase("li      t1,15", 0x00f00313u)]
        [TestCase("mv      a4,a0", 0x00050713u)]
        [TestCase("andi    a5,a4,15", 0x00f77793u)]
        [TestCase("andi    a3,a2,-16", 0xff067693u)]
        [TestCase("andi    a2,a2,15", 0x00f67613u)]
        [TestCase("add     a3,a3,a4", 0x00e686b3u)]
        [TestCase("sd      a1,0(a4)", 0x00b73023u)]
        [TestCase("sd      a1,8(a4)", 0x00b73423u)]
        [TestCase("addi    a4,a4,16", 0x01070713u)]
        [TestCase("sub     a3,t1,a2", 0x40c306b3u)]
        [TestCase("slli    a3,a3,0x2", 0x00269693u)]
        [TestCase("auipc   t0,0x0", 0x00000297u)]
        [TestCase("add     a3,a3,t0", 0x005686b3u)]
        [TestCase("jr      12(a3)", 0x00c68067u)]
        [TestCase("sb      a1,14(a4)", 0x00b70723u)]
        [TestCase("sb      a1,13(a4)", 0x00b706a3u)]
        [TestCase("sb      a1,12(a4)", 0x00b70623u)]
        [TestCase("sb      a1,11(a4)", 0x00b705a3u)]
        [TestCase("sb      a1,10(a4)", 0x00b70523u)]
        [TestCase("sb      a1,9(a4)", 0x00b704a3u)]
        [TestCase("sb      a1,8(a4)", 0x00b70423u)]
        [TestCase("sb      a1,7(a4)", 0x00b703a3u)]
        [TestCase("sb      a1,6(a4)", 0x00b70323u)]
        [TestCase("sb      a1,5(a4)", 0x00b702a3u)]
        [TestCase("sb      a1,4(a4)", 0x00b70223u)]
        [TestCase("sb      a1,3(a4)", 0x00b701a3u)]
        [TestCase("sb      a1,2(a4)", 0x00b70123u)]
        [TestCase("sb      a1,1(a4)", 0x00b700a3u)]
        [TestCase("sb      a1,0(a4)", 0x00b70023u)]
        [TestCase("andi    a1,a1,255", 0x0ff5f593u)]
        [TestCase("slli    a3,a1,0x8", 0x00859693u)]
        [TestCase("or      a1,a1,a3", 0x00d5e5b3u)]
        [TestCase("slli    a3,a1,0x10", 0x01059693u)]
        [TestCase("slli    a3,a1,0x20", 0x02059693u)]
        [TestCase("slli    a3,a5,0x2", 0x00279693u)]
        [TestCase("mv      t0,ra", 0x00008293u)]
        [TestCase("jalr    -104(a3)", 0xf98680e7u)]
        [TestCase("mv      ra,t0", 0x00028093u)]
        [TestCase("addi    a5,a5,-16", 0xff078793u)]
        [TestCase("sub     a4,a4,a5", 0x40f70733u)]
        [TestCase("add     a2,a2,a5", 0x00f60633u)]
        [TestCase("addi    sp,sp,-80", 0xfb010113u)]
        [TestCase("sd      s4,32(sp)", 0x03413023u)]
        [TestCase("sd      s2,48(sp)", 0x03213823u)]
        [TestCase("sd      ra,72(sp)", 0x04113423u)]
        [TestCase("ld      s2,504(s4)", 0x1f8a3903u)]
        [TestCase("sd      s0,64(sp)", 0x04813023u)]
        [TestCase("sd      s1,56(sp)", 0x02913c23u)]
        [TestCase("sd      s3,40(sp)", 0x03313423u)]
        [TestCase("sd      s5,24(sp)", 0x01513c23u)]
        [TestCase("sd      s6,16(sp)", 0x01613823u)]
        [TestCase("sd      s7,8(sp)", 0x01713423u)]
        [TestCase("sd      s8,0(sp)", 0x01813023u)]
        [TestCase("mv      s6,a0", 0x00050b13u)]
        [TestCase("mv      s7,a1", 0x00058b93u)]
        [TestCase("li      s5,1", 0x00100a93u)]
        [TestCase("li      s3,-1", 0xfff00993u)]
        [TestCase("lw      s1,8(s2)", 0x00892483u)]
        [TestCase("addiw   s0,s1,-1", 0xfff4841bu)]
        [TestCase("slli    s1,s1,0x3", 0x00349493u)]
        [TestCase("add     s1,s2,s1", 0x009904b3u)]
        [TestCase("ld      a5,520(s1)", 0x2084b783u)]
        [TestCase("addiw   s0,s0,-1", 0xfff4041bu)]
        [TestCase("addi    s1,s1,-8", 0xff848493u)]
        [TestCase("ld      ra,72(sp)", 0x04813083u)]
        [TestCase("ld      s0,64(sp)", 0x04013403u)]
        [TestCase("ld      s1,56(sp)", 0x03813483u)]
        [TestCase("ld      s2,48(sp)", 0x03013903u)]
        [TestCase("ld      s3,40(sp)", 0x02813983u)]
        [TestCase("ld      s4,32(sp)", 0x02013a03u)]
        [TestCase("ld      s5,24(sp)", 0x01813a83u)]
        [TestCase("ld      s6,16(sp)", 0x01013b03u)]
        [TestCase("ld      s7,8(sp)", 0x00813b83u)]
        [TestCase("ld      s8,0(sp)", 0x00013c03u)]
        [TestCase("addi    sp,sp,80", 0x05010113u)]
        [TestCase("lw      a5,8(s2)", 0x00892783u)]
        [TestCase("ld      a4,8(s1)", 0x0084b703u)]
        [TestCase("addiw   a5,a5,-1", 0xfff7879bu)]
        [TestCase("sd      zero,8(s1)", 0x0004b423u)]
        [TestCase("lw      a5,784(s2)", 0x31092783u)]
        [TestCase("sllw    a3,s5,s0", 0x008a96bbu)]
        [TestCase("lw      s8,8(s2)", 0x00892c03u)]
        [TestCase("and     a5,a5,a3", 0x00d7f7b3u)]
        [TestCase("sext.w  a5,a5", 0x0007879bu)]
        [TestCase("jalr    a4", 0x000700e7u)]
        [TestCase("lw      a4,8(s2)", 0x00892703u)]
        [TestCase("ld      a5,504(s4)", 0x1f8a3783u)]
        [TestCase("mv      s2,a5", 0x00078913u)]
        [TestCase("lw      a5,788(s2)", 0x31492783u)]
        [TestCase("ld      a1,264(s1)", 0x1084b583u)]
        [TestCase("mv      a0,s6", 0x000b0513u)]
        [TestCase("sw      s0,8(s2)", 0x00892423u)]
        [TestCase("mv      a0,a1", 0x00058513u)]
        [TestCase("mv      a1,a0", 0x00050593u)]
        [TestCase("li      a3,0", 0x00000693u)]
        [TestCase("li      a0,0", 0x00000513u)]
        [TestCase("lui     a5,0x11", 0x000117b7u)]
        [TestCase("sub     a5,a5,s0", 0x408787b3u)]
        [TestCase("srai    s1,a5,0x3", 0x4037d493u)]
        [TestCase("addi    a5,a5,-8", 0xff878793u)]
        [TestCase("add     s0,a5,s0", 0x00878433u)]
        [TestCase("addi    s1,s1,-1", 0xfff48493u)]
        [TestCase("addi    s0,s0,-8", 0xff840413u)]
        [TestCase("ld      a5,504(a4)", 0x1f873783u)]
        [TestCase("lw      a4,8(a5)", 0x0087a703u)]
        [TestCase("li      a6,31", 0x01f00813u)]
        [TestCase("slli    a6,a4,0x3", 0x00371813u)]
        [TestCase("add     a6,a5,a6", 0x01078833u)]
        [TestCase("sd      a2,272(a6)", 0x10c83823u)]
        [TestCase("lw      a7,784(a5)", 0x3107a883u)]
        [TestCase("li      a2,1", 0x00100613u)]
        [TestCase("sllw    a2,a2,a4", 0x00e6163bu)]
        [TestCase("or      a7,a7,a2", 0x00c8e8b3u)]
        [TestCase("sw      a7,784(a5)", 0x3117a823u)]
        [TestCase("sd      a3,528(a6)", 0x20d83823u)]
        [TestCase("li      a3,2", 0x00200693u)]
        [TestCase("addi    a3,a4,2", 0x00270693u)]
        [TestCase("slli    a3,a3,0x3", 0x00369693u)]
        [TestCase("addiw   a4,a4,1", 0x0017071bu)]
        [TestCase("sw      a4,8(a5)", 0x00e7a423u)]
        [TestCase("add     a5,a5,a3", 0x00d787b3u)]
        [TestCase("sd      a1,0(a5)", 0x00b7b023u)]
        [TestCase("addi    a5,a4,512", 0x20070793u)]
        [TestCase("sd      a5,504(a4)", 0x1ef73c23u)]
        [TestCase("lw      a3,788(a5)", 0x3147a683u)]
        [TestCase("or      a2,a3,a2", 0x00c6e633u)]
        [TestCase("sw      a2,788(a5)", 0x30c7aa23u)]
        [TestCase("li      a0,-1", 0xfff00513u)]
        [TestCase("li      a4,0", 0x00000713u)]
        [TestCase("li      a7,93", 0x05d00893u)]
        [TestCase("ecall", 0x00000073u)]
        [TestCase("negw    s0,s0", 0x4080043bu)]
        [TestCase("sw      s0,0(a0)", 0x00852023u)]
        [TestCase("ebreak", 0x00100073u)]
        public void compileDataSingle(string str, uint code)
        {
            uint result = KuickCompiler.compile(str);
            Assert.AreEqual(code, result,
                TestUtils.getDataMismatchString(code,result)
            );
        }

        [TestCase("beqz    a5,100c4 <register_fini+0x14>", 0x00078863u)]
        [TestCase("addi    a0,a0,1128 # 10468 <__libc_fini_array>", 0x46850513u)]
        [TestCase("j       10454 <atexit>", 0x3940006fu)]
        [TestCase("addi    gp,gp,-752 # 11dd8 <__global_pointer$>", 0xd1018193u)]
        [TestCase("addi    a0,gp,-160 # 11d38 <completed.1>", 0xf6018513u)]
        [TestCase("addi    a2,gp,-104 # 11d70 <__BSS_END__>", 0xf9818613u)]
        [TestCase("jal     ra,10250 <memset>", 0x170000efu)]
        [TestCase("addi    a0,a0,880 # 10454 <atexit>", 0x37050513u)]
        [TestCase("beqz    a0,100fc <_start+0x34>", 0x00050863u)]
        [TestCase("addi    a0,a0,888 # 10468 <__libc_fini_array>", 0x37850513u)]
        [TestCase("jal     ra,10454 <atexit>", 0x35c000efu)]
        [TestCase("jal     ra,101b4 <__libc_init_array>", 0x0b8000efu)]
        [TestCase("jal     ra,10180 <main>", 0x074000efu)]
        [TestCase("j       10184 <exit>", 0x0740006fu)]
        [TestCase("lbu     a4,-160(gp) # 11d38 <completed.1>", 0xf601c703u)]
        [TestCase("bnez    a4,1015c <__do_global_dtors_aux+0x48>", 0x04071263u)]
        [TestCase("beqz    a5,10144 <__do_global_dtors_aux+0x30>", 0x00078a63u)]
        [TestCase("addi    a0,a0,1464 # 115b8 <__FRAME_END__>", 0x5b850513u)]
        [TestCase("jalr    zero # 0 <register_fini-0x100b0>", 0x000000e7u)]
        [TestCase("sb      a5,-160(gp) # 11d38 <completed.1>", 0xf6f18023u)]
        [TestCase("beqz    a5,1017c <frame_dummy+0x1c>", 0x00078c63u)]
        [TestCase("addi    a1,gp,-152 # 11d40 <object.0>", 0xf6818593u)]
        [TestCase("jr      zero # 0 <register_fini-0x100b0>", 0x00000067u)]
        [TestCase("addi    t0,t1,10 # 1017e <frame_dummy+0x1e>", 0x00a30293u)]
        [TestCase("jal     ra,1032c <__call_exitprocs>", 0x194000efu)]
        [TestCase("ld      a0,-184(gp) # 11d20 <_global_impure_ptr>", 0xf481b503u)]
        [TestCase("beqz    a5,101ac <exit+0x28>", 0x00078463u)]
        [TestCase("jal     ra,1056c <_exit>", 0x3bc000efu)]
        [TestCase("addi    a5,s0,1468 # 115bc <__preinit_array_end>", 0x5bc40793u)]
        [TestCase("addi    s2,s2,1468 # 115bc <__preinit_array_end>", 0x5bc90913u)]
        [TestCase("beqz    s2,10200 <__libc_init_array+0x4c>", 0x02090063u)]
        [TestCase("bne     s2,s1,101ec <__libc_init_array+0x38>", 0xfe9918e3u)]
        [TestCase("addi    a5,s0,1472 # 115c0 <__init_array_start>", 0x5c040793u)]
        [TestCase("addi    s2,s2,1488 # 115d0 <__do_global_dtors_aux_fini_array_entry>", 0x5d090913u)]
        [TestCase("beqz    s2,10238 <__libc_init_array+0x84>", 0x02090063u)]
        [TestCase("bne     s2,s1,10224 <__libc_init_array+0x70>", 0xfe9918e3u)]
        [TestCase("bgeu    t1,a2,1028c <memset+0x3c>", 0x02c37a63u)]
        [TestCase("bnez    a5,10300 <memset+0xb0>", 0x0a079063u)]
        [TestCase("bnez    a1,102e0 <memset+0x90>", 0x06059e63u)]
        [TestCase("bltu    a4,a3,10274 <memset+0x24>", 0xfed76ae3u)]
        [TestCase("bnez    a2,1028c <memset+0x3c>", 0x00061463u)]
        [TestCase("j       10268 <memset+0x18>", 0xf6dff06fu)]
        [TestCase("bgeu    t1,a2,1028c <memset+0x3c>", 0xf6c374e3u)]
        [TestCase("j       10264 <memset+0x14>", 0xf3dff06fu)]
        [TestCase("ld      s4,-184(gp) # 11d20 <_global_impure_ptr>", 0xf481ba03u)]
        [TestCase("beqz    s2,103a0 <__call_exitprocs+0x74>", 0x04090063u)]
        [TestCase("bltz    s0,103a0 <__call_exitprocs+0x74>", 0x02044263u)]
        [TestCase("beqz    s7,103d0 <__call_exitprocs+0xa4>", 0x040b8463u)]
        [TestCase("beq     a5,s7,103d0 <__call_exitprocs+0xa4>", 0x05778063u)]
        [TestCase("bne     s0,s3,10388 <__call_exitprocs+0x5c>", 0xff3416e3u)]
        [TestCase("beq     a5,s0,10440 <__call_exitprocs+0x114>", 0x06878263u)]
        [TestCase("beqz    a4,10394 <__call_exitprocs+0x68>", 0xfa0708e3u)]
        [TestCase("bnez    a5,10420 <__call_exitprocs+0xf4>", 0x02079263u)]
        [TestCase("bne     a4,s8,10414 <__call_exitprocs+0xe8>", 0x01871463u)]
        [TestCase("beq     a5,s2,10394 <__call_exitprocs+0x68>", 0xf92782e3u)]
        [TestCase("beqz    a5,103a0 <__call_exitprocs+0x74>", 0xf80786e3u)]
        [TestCase("j       10374 <__call_exitprocs+0x48>", 0xf59ff06fu)]
        [TestCase("bnez    a5,10448 <__call_exitprocs+0x11c>", 0x00079c63u)]
        [TestCase("j       10404 <__call_exitprocs+0xd8>", 0xfc9ff06fu)]
        [TestCase("j       103e4 <__call_exitprocs+0xb8>", 0xfa1ff06fu)]
        [TestCase("j       10404 <__call_exitprocs+0xd8>", 0xfb5ff06fu)]
        [TestCase("j       104c4 <__register_exitproc>", 0x0600006fu)]
        [TestCase("addi    s0,s0,1488 # 115d0 <__do_global_dtors_aux_fini_array_entry>", 0x5d040413u)]
        [TestCase("addi    a5,a5,1496 # 115d8 <impure_data>", 0x5d878793u)]
        [TestCase("beqz    s1,104b0 <__libc_fini_array+0x48>", 0x02048063u)]
        [TestCase("bnez    s1,1049c <__libc_fini_array+0x34>", 0xfe0498e3u)]
        [TestCase("ld      a4,-184(gp) # 11d20 <_global_impure_ptr>", 0xf481b703u)]
        [TestCase("beqz    a5,1052c <__register_exitproc+0x68>", 0x06078063u)]
        [TestCase("blt     a6,a4,10564 <__register_exitproc+0xa0>", 0x08e84663u)]
        [TestCase("beqz    a0,1050c <__register_exitproc+0x48>", 0x02050863u)]
        [TestCase("beq     a0,a3,10538 <__register_exitproc+0x74>", 0x02d50863u)]
        [TestCase("j       104d0 <__register_exitproc+0xc>", 0xf9dff06fu)]
        [TestCase("bltz    a0,10590 <_exit+0x24>", 0x00054463u)]
        [TestCase("j       1058c <_exit+0x20>", 0x0000006fu)]
        [TestCase("jal     ra,105b0 <__errno>", 0x00c000efu)]
        [TestCase("j       105ac <_exit+0x40>", 0x0000006fu)]
        [TestCase("ld      a0,-168(gp) # 11d30 <_impure_ptr>", 0xf581b503u)]
        public void compileDataSingleComplexRef(string str, uint code)
        {
            uint result = KuickCompiler.compile(str);
            Assert.AreEqual(code, result,
                "Data Mismatch\n" +
                Convert.ToString((int)(code), 2).PadLeft(32, '0') +
                "\n" +
                Convert.ToString((int)(result), 2).PadLeft(32, '0')
            );
        }

        [Test, Ignore("Not Understood Yet")]
        public void asemblerMacros(string[] strings, uint[] codes)
        {
        }

        public void compileDataMulti(string[] strings, uint[] codes)
        {
        }

        public void compileRTypeStruct(string str, RType inst)
        {
        }

        public void compileITypeStruct(string str, IType inst)
        {
        }

        public void compileSTypeStruct(string str, SType inst)
        {
        }

        public void compileBTypeStruct(string str, BType inst)
        {
        }

        public void compileUTypeStruct(string str, UType inst)
        {
        }

        public void compileJTypeStruct(string str, JType inst)
        {
        }
    }
}
